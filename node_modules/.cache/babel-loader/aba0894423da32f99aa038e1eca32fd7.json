{"ast":null,"code":"import _regeneratorRuntime from\"/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from'react';import{connect}from'react-redux';import{decode}from'he';import fetchTriviaApi from'../../services/triviaApi';import TableApp from'../../components/Table';import Button from'../../components/Button';import{requestToken,setPlayer}from'../../store/actions';import fetchToken from'../../services/token';import Loading from'../../components/Loading';import{HALF,ONE,TWO,THREE,FOUR,TEN,THIRTY,THOUSAND}from'../../commons/constants';import'./style.css';import logo from'../../assets/images/logo.png';import{entrada,handleConversation,handlePlay,rightAnswer,wrongAnswer}from'./audio';function Game(props){var interval=useRef();var dispatchPlayer=props.dispatchPlayer,dispatchToken=props.dispatchToken,history=props.history,_props$player=props.player,name=_props$player.name,assertions=_props$player.assertions,score=_props$player.score,total=_props$player.total,gravatarEmail=_props$player.gravatarEmail,token=props.token;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),questions=_useState2[0],setQuestions=_useState2[1];// const [newQuestionSound, setNewQuestionSound] = useState(0);\nvar _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),countQuestions=_useState4[0],setCountQuestions=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),index=_useState6[0],setIndex=_useState6[1];var _useState7=useState(THIRTY),_useState8=_slicedToArray(_useState7,2),timer=_useState8[0],setTimer=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),timeEnd=_useState10[0],setTimeEnd=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),disabled=_useState12[0],setDisabled=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),loading=_useState14[0],setLoading=_useState14[1];var answerCorrect=useRef(false);var answerIncorrect=useRef(false);var _useState15=useState({correct:'',incorrect:[],all:[]}),_useState16=_slicedToArray(_useState15,2),answers=_useState16[0],setAnswers=_useState16[1];var man=['man1','man2','man3','man4','man5','man6','man7'];function handleTrivia(){return _handleTrivia.apply(this,arguments);}function _handleTrivia(){_handleTrivia=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var fetchTrivia,tokenInfo;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setLoading(true);_context.next=3;return fetchTriviaApi(token);case 3:fetchTrivia=_context.sent;if(!(fetchTrivia.response_code===THREE)){_context.next=12;break;}_context.next=7;return fetchToken();case 7:tokenInfo=_context.sent;dispatchToken(tokenInfo.token);_context.next=11;return fetchTriviaApi(tokenInfo.token);case 11:fetchTrivia=_context.sent;case 12:setQuestions(fetchTrivia.results);setLoading(false);case 14:case\"end\":return _context.stop();}}},_callee);}));return _handleTrivia.apply(this,arguments);}function handleAnswers(){if(questions.length>0){var _questions$index=questions[index],correct=_questions$index.correct_answer,incorrect=_questions$index.incorrect_answers;// https://flaviocopes.com/how-to-shuffle-array-javascript/\nvar all=[correct].concat(_toConsumableArray(incorrect));all=all.sort(function(){return Math.random()-HALF;});setAnswers(_objectSpread(_objectSpread({},answers),{},{correct:correct,incorrect:incorrect,all:all}));}}// https://stackoverflow.com/questions/71184843/how-to-update-state-using-setinterval-on-functional-components-in-react/71185514#71185514\nfunction handleTimer(){// interval useRef para funcionar\nfunction runTimer(){interval.current=setInterval(function(){setTimer(function(count){return count-1;});},THOUSAND);}if(timer<=0&&interval.current){setDisabled(true);setTimeEnd(true);handlePlay(wrongAnswer[Math.floor(Math.random()*wrongAnswer.length)]);clearInterval(interval.current);}if(timer===THIRTY){runTimer();}}function calcScore(){var level=questions[index].difficulty;if(level==='hard')return THREE;if(level==='medium')return TWO;return ONE;}function handleClick(_ref){var target=_ref.target;var correct=target.getAttribute('data-testid').includes('correct');if(correct){var player={name:name,assertions:assertions+1,score:TEN+timer*calcScore(),total:total+(TEN+timer*calcScore()),gravatarEmail:gravatarEmail};handlePlay(rightAnswer[Math.floor(Math.random()*rightAnswer.length)]);dispatchPlayer(player);answerCorrect.current=true;}else{handlePlay(wrongAnswer[Math.floor(Math.random()*wrongAnswer.length)]);answerIncorrect.current=true;}setDisabled(true);clearInterval(interval.current);}function handleNext(){setCountQuestions(countQuestions+1);setIndex(index+1);setDisabled(false);answerCorrect.current=false;answerIncorrect.current=false;setTimer(THIRTY);handleAnswers();if(countQuestions===FOUR){setCountQuestions(0);history.push('/feedback');}}useEffect(function(){// did mount\nhandleTrivia();},[]);useEffect(function(){// did update\nhandleAnswers();},[questions]);useEffect(function(){// did update\nhandlePlay(entrada);},[index]);useEffect(function(){// did update\nhandleTimer();handleConversation(timer);},[timer]);return/*#__PURE__*/React.createElement(\"div\",{className:\"game\"},/*#__PURE__*/React.createElement(\"div\",{className:\"game__left\"},/*#__PURE__*/React.createElement(\"header\",null,/*#__PURE__*/React.createElement(\"img\",{src:logo,alt:\"Logo\",className:\"game__logo\"}),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"p\",{className:\"game__score\"},\"Pontos: \".concat(score)),/*#__PURE__*/React.createElement(\"p\",{className:\"game__total\"},\"Total: \".concat(total)),questions.length>0&&/*#__PURE__*/React.createElement(\"span\",{className:\"game__category\"},/*#__PURE__*/React.createElement(\"p\",{\"data-testid\":\"question-category\"},decode(questions[index].category)))),/*#__PURE__*/React.createElement(\"div\",{className:\"game__timer\"},/*#__PURE__*/React.createElement(\"div\",{className:\"game__circle\"},\"\\xA0\"),/*#__PURE__*/React.createElement(\"span\",null,timer))),/*#__PURE__*/React.createElement(\"main\",null,loading&&/*#__PURE__*/React.createElement(Loading,null),questions.length>0&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{className:\"game__question\"},/*#__PURE__*/React.createElement(\"div\",{\"data-testid\":\"question-text\",className:\"game__text\"},decode(questions[index].question))),/*#__PURE__*/React.createElement(\"div\",{className:\"game__answers\",\"data-testid\":\"answer-options\"},answers.all.map(function(answer,item){return/*#__PURE__*/React.createElement(Button,{className:answer===answers.correct?'correct game__answer-txt':'incorrect game__answer-txt',dataTestid:answer===answers.correct?'correct-answer':\"wrong-answer-\".concat(item),disabled:disabled,index:item,key:item,onClick:function onClick(event){return handleClick(event);},text:decode(answer),type:\"button\"});})),/*#__PURE__*/React.createElement(\"div\",{className:\"game__messages\"},disabled&&timeEnd&&/*#__PURE__*/React.createElement(\"p\",{className:\"msg__timeup\"},\"Tempo esgotado! Resposta inv\\xE1lida.\"),disabled&&answerIncorrect.current&&/*#__PURE__*/React.createElement(\"p\",{className:\"msg__wrong\"},\"Infelizmente voc\\xEA errou!\"),disabled&&answerCorrect.current&&/*#__PURE__*/React.createElement(\"p\",{className:\"msg__right\"},\"Parab\\xE9ns! Voc\\xEA acertou!\"))),/*#__PURE__*/React.createElement(\"div\",{className:\"game__footer\"},/*#__PURE__*/React.createElement(TableApp,{className:\"game__profile-name\",classPicture:\"game__profile-picture\",classPictureImage:\"game__profile-image\",classScore:\"game__profile-score\",classTable:\"game__profile\",name:name,score:score,gravatarEmail:gravatarEmail}),disabled&&/*#__PURE__*/React.createElement(Button,{className:\"next\",dataTestid:\"btn-next\",onClick:function onClick(){return handleNext();},text:\"Next\",type:\"button\"})))),/*#__PURE__*/React.createElement(\"div\",{className:\"game__right \".concat(man[index])},\"\\xA0\"));}var mapStateToProps=function mapStateToProps(state){return{player:state.player,token:state.token};};var mapDispatchToProps=function mapDispatchToProps(dispatch){return{dispatchToken:function dispatchToken(tokenInfo){return dispatch(requestToken(tokenInfo));},dispatchPlayer:function dispatchPlayer(player){return dispatch(setPlayer(player));}};};export default connect(mapStateToProps,mapDispatchToProps)(Game);","map":{"version":3,"sources":["/home/kelson/Projetos/trybe-projetos/16-sd-017-project-trivia-react-redux/src/pages/Game/index.jsx"],"names":["React","useState","useEffect","useRef","connect","decode","fetchTriviaApi","TableApp","Button","requestToken","setPlayer","fetchToken","Loading","HALF","ONE","TWO","THREE","FOUR","TEN","THIRTY","THOUSAND","logo","entrada","handleConversation","handlePlay","rightAnswer","wrongAnswer","Game","props","interval","dispatchPlayer","dispatchToken","history","player","name","assertions","score","total","gravatarEmail","token","questions","setQuestions","countQuestions","setCountQuestions","index","setIndex","timer","setTimer","timeEnd","setTimeEnd","disabled","setDisabled","loading","setLoading","answerCorrect","answerIncorrect","correct","incorrect","all","answers","setAnswers","man","handleTrivia","fetchTrivia","response_code","tokenInfo","results","handleAnswers","length","correct_answer","incorrect_answers","sort","Math","random","handleTimer","runTimer","current","setInterval","count","floor","clearInterval","calcScore","level","difficulty","handleClick","target","getAttribute","includes","handleNext","push","category","question","map","answer","item","event","mapStateToProps","state","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport PropTypes from 'prop-types';\nimport { connect } from 'react-redux';\nimport { decode } from 'he';\nimport fetchTriviaApi from '../../services/triviaApi';\nimport TableApp from '../../components/Table';\nimport Button from '../../components/Button';\nimport { requestToken, setPlayer } from '../../store/actions';\nimport fetchToken from '../../services/token';\nimport Loading from '../../components/Loading';\nimport { HALF, ONE, TWO, THREE, FOUR,\n  TEN, THIRTY, THOUSAND } from '../../commons/constants';\nimport './style.css';\nimport logo from '../../assets/images/logo.png';\nimport { entrada, handleConversation,\n  handlePlay, rightAnswer, wrongAnswer } from './audio';\n\nfunction Game(props) {\n  const interval = useRef();\n  const { dispatchPlayer, dispatchToken, history,\n    player: { name, assertions, score, total, gravatarEmail }, token } = props;\n  const [questions, setQuestions] = useState([]);\n  // const [newQuestionSound, setNewQuestionSound] = useState(0);\n  const [countQuestions, setCountQuestions] = useState(0);\n  const [index, setIndex] = useState(0);\n  const [timer, setTimer] = useState(THIRTY);\n  const [timeEnd, setTimeEnd] = useState(false);\n  const [disabled, setDisabled] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const answerCorrect = useRef(false);\n  const answerIncorrect = useRef(false);\n  const [answers, setAnswers] = useState({\n    correct: '',\n    incorrect: [],\n    all: [],\n  });\n\n  const man = ['man1', 'man2', 'man3', 'man4', 'man5', 'man6', 'man7'];\n\n  async function handleTrivia() {\n    setLoading(true);\n    let fetchTrivia = await fetchTriviaApi(token);\n    if (fetchTrivia.response_code === THREE) {\n      const tokenInfo = await fetchToken();\n      dispatchToken(tokenInfo.token);\n      fetchTrivia = await fetchTriviaApi(tokenInfo.token);\n    }\n    setQuestions(fetchTrivia.results);\n    setLoading(false);\n  }\n\n  function handleAnswers() {\n    if (questions.length > 0) {\n      const {\n        correct_answer: correct,\n        incorrect_answers: incorrect,\n      } = questions[index];\n      // https://flaviocopes.com/how-to-shuffle-array-javascript/\n      let all = [correct, ...incorrect];\n      all = all.sort(() => Math.random() - HALF);\n      setAnswers({\n        ...answers,\n        correct,\n        incorrect,\n        all,\n      });\n    }\n  }\n\n  // https://stackoverflow.com/questions/71184843/how-to-update-state-using-setinterval-on-functional-components-in-react/71185514#71185514\n  function handleTimer() { // interval useRef para funcionar\n    function runTimer() {\n      interval.current = setInterval(() => {\n        setTimer((count) => count - 1);\n      }, THOUSAND);\n    }\n    if (timer <= 0 && interval.current) {\n      setDisabled(true);\n      setTimeEnd(true);\n      handlePlay(wrongAnswer[Math.floor(Math.random() * wrongAnswer.length)]);\n      clearInterval(interval.current);\n    }\n    if (timer === THIRTY) {\n      runTimer();\n    }\n  }\n\n  function calcScore() {\n    const level = questions[index].difficulty;\n    if (level === 'hard') return THREE;\n    if (level === 'medium') return TWO;\n    return ONE;\n  }\n\n  function handleClick({ target }) {\n    const correct = target.getAttribute('data-testid').includes('correct');\n    if (correct) {\n      const player = {\n        name,\n        assertions: assertions + 1,\n        score: TEN + (timer * calcScore()),\n        total: total + (TEN + (timer * calcScore())),\n        gravatarEmail,\n      };\n      handlePlay(rightAnswer[Math.floor(Math.random() * rightAnswer.length)]);\n      dispatchPlayer(player);\n      answerCorrect.current = true;\n    } else {\n      handlePlay(wrongAnswer[Math.floor(Math.random() * wrongAnswer.length)]);\n      answerIncorrect.current = true;\n    }\n    setDisabled(true);\n    clearInterval(interval.current);\n  }\n\n  function handleNext() {\n    setCountQuestions(countQuestions + 1);\n    setIndex(index + 1);\n    setDisabled(false);\n    answerCorrect.current = false;\n    answerIncorrect.current = false;\n    setTimer(THIRTY);\n    handleAnswers();\n    if (countQuestions === FOUR) {\n      setCountQuestions(0);\n      history.push('/feedback');\n    }\n  }\n\n  useEffect(() => { // did mount\n    handleTrivia();\n  }, []);\n\n  useEffect(() => { // did update\n    handleAnswers();\n  }, [questions]);\n\n  useEffect(() => { // did update\n    handlePlay(entrada);\n  }, [index]);\n\n  useEffect(() => { // did update\n    handleTimer();\n    handleConversation(timer);\n  }, [timer]);\n\n  return (\n    <div className=\"game\">\n      <div className=\"game__left\">\n        <header>\n          <img src={ logo } alt=\"Logo\" className=\"game__logo\" />\n          <div>\n            <p className=\"game__score\">{ `Pontos: ${score}` }</p>\n            <p className=\"game__total\">{ `Total: ${total}` }</p>\n            { questions.length > 0 && (\n              <span className=\"game__category\">\n                <p data-testid=\"question-category\">\n                  { decode(questions[index].category) }\n                </p>\n              </span>\n            ) }\n          </div>\n          <div className=\"game__timer\">\n            <div className=\"game__circle\">&nbsp;</div>\n            <span>{ timer }</span>\n          </div>\n        </header>\n        <main>\n          { loading && <Loading />}\n          { questions.length > 0 && (\n            <div>\n              <div className=\"game__question\">\n                <div data-testid=\"question-text\" className=\"game__text\">\n                  {/* { setNewQuestionSound(1) } */}\n                  { decode(questions[index].question) }\n                </div>\n              </div>\n              <div className=\"game__answers\" data-testid=\"answer-options\">\n                { /* // https://flaviocopes.com/how-to-shuffle-array-javascript/ */}\n                { answers.all.map((answer, item) => (\n                  <Button\n                    className={ ((answer === answers.correct)\n                      ? 'correct game__answer-txt'\n                      : 'incorrect game__answer-txt') }\n                    dataTestid={ (answer === answers.correct\n                      ? 'correct-answer'\n                      : `wrong-answer-${item}`) }\n                    disabled={ disabled }\n                    index={ item }\n                    key={ item }\n                    onClick={ (event) => handleClick(event) }\n                    text={ decode(answer) }\n                    type=\"button\"\n                  />\n                )) }\n              </div>\n              <div className=\"game__messages\">\n                { (disabled && timeEnd)\n                && <p className=\"msg__timeup\">Tempo esgotado! Resposta inválida.</p>}\n                { (disabled && answerIncorrect.current)\n                  && <p className=\"msg__wrong\">Infelizmente você errou!</p>}\n                { (disabled && answerCorrect.current)\n                && <p className=\"msg__right\">Parabéns! Você acertou!</p>}\n              </div>\n            </div>\n          )}\n          <div className=\"game__footer\">\n            <TableApp\n              className=\"game__profile-name\"\n              classPicture=\"game__profile-picture\"\n              classPictureImage=\"game__profile-image\"\n              classScore=\"game__profile-score\"\n              classTable=\"game__profile\"\n              name={ name }\n              score={ score }\n              gravatarEmail={ gravatarEmail }\n            />\n            { disabled && (\n              <Button\n                className=\"next\"\n                dataTestid=\"btn-next\"\n                onClick={ () => handleNext() }\n                text=\"Next\"\n                type=\"button\"\n              />\n            )}\n          </div>\n        </main>\n      </div>\n      <div className={ `game__right ${man[index]}` }>\n        &nbsp;\n      </div>\n    </div>\n  );\n}\n\nGame.propTypes = {\n  name: PropTypes.string,\n  score: PropTypes.number,\n  token: PropTypes.string,\n  history: PropTypes.instanceOf(Object),\n}.isRequired;\n\nconst mapStateToProps = (state) => ({\n  player: state.player,\n  token: state.token,\n});\n\nconst mapDispatchToProps = (dispatch) => ({\n  dispatchToken: (tokenInfo) => dispatch(requestToken(tokenInfo)),\n  dispatchPlayer: (player) => dispatch(setPlayer(player)),\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(Game);\n"]},"metadata":{},"sourceType":"module"}